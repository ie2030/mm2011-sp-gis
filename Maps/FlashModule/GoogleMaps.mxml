<?xml version="1.0" encoding="utf-8"?>
<mx:Application xmlns:mx="http://www.adobe.com/2006/mxml" layout="absolute">

<maps:Map xmlns:maps="com.google.maps.*"
    id="map"
    mapevent_mapready="onMapReady(event)"
    width="100%"
    height="100%"
    sensor="false"
    key="ABQIAAAA6Je9wEhpps-6h4SLEzfx0hQcnJAsAPU0edVn7hFTQC8ea3A_VBRkCS6mZzjo_25VBG1y_bIKsYiRMg" />

<mx:Script>
<![CDATA[
    import com.google.maps.services.ClientGeocoderOptions;
    import com.google.maps.overlays.Marker;
    import com.google.maps.controls.MapTypeControl;
    import com.google.maps.controls.PositionControl;
    import com.google.maps.controls.ZoomControl;
    import com.google.maps.InfoWindowOptions;
    import com.google.maps.MapMouseEvent;
    import com.google.maps.services.ClientGeocoder;
    import com.google.maps.services.GeocodingEvent;
    import com.google.maps.LatLng;
    import com.google.maps.Map;
    import com.google.maps.MapEvent;
    import com.google.maps.MapType;
    import mx.controls.Alert;

    private var marker : Marker;

    private function onMapReady(event:Event):void {
        var centerLL : LatLng = new LatLng(59.939039, 30.315758);
        map.setCenter(centerLL, 14, MapType.NORMAL_MAP_TYPE);

        map.addControl(new ZoomControl());
        map.addControl(new PositionControl());
        map.addControl(new MapTypeControl());

        map.addEventListener(MapMouseEvent.CLICK, onMapClick);

        marker = new Marker(centerLL);
        map.addOverlay(marker);

        ExternalInterface.addCallback("Search", onSearch);
    }

    private function onMapClick(event:MapMouseEvent):void {
        marker.setLatLng(event.latLng);
        ExternalInterface.call("setPosition", marker.getLatLng().lat(), marker.getLatLng().lng());
    }

    private function onSearch(address:String):void {
        var geocoder : ClientGeocoder = new ClientGeocoder();

        geocoder.addEventListener(GeocodingEvent.GEOCODING_SUCCESS,
            function(event: GeocodingEvent):void{
                var placemarks:Array = event.response.placemarks;
                if (placemarks.length > 1){
                    map.setCenter(placemarks[0].point);
                    marker.setLatLng(placemarks[0].point);
                    ExternalInterface.call("setPosition", marker.getLatLng().lat(), marker.getLatLng().lng());

                }
            });
        geocoder.addEventListener(GeocodingEvent.GEOCODING_FAILURE,
            function(event: GeocodingEvent):void {
                Alert.show("Geocoding failed");
            });
        geocoder.geocode(address);
    }

]]>
</mx:Script>
</mx:Application>